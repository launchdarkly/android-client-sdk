version: 2.1

orbs:
  android: circleci/android@2.1.2

workflows:
  test:
    jobs:
      - package
      - unit-tests
      - instrumented-tests:
          matrix:
            parameters:
              api-level:
                # - 21 - TODO: EasyMock makes our tests fail
                - 25
                # - 30 - TODO: timeouts
                # - 31 - https://github.com/CircleCI-Public/android-orb/issues/52
      - contract-tests:
          matrix:
            parameters:
              api-level:
                # - 21 - TODO: flaky contract tests
                - 25
                - 30

commands:
  check-emulator-available:
    steps:
      # Additional validation that emulator is fully started and will accept adb
      # commands
      - run:
          name: Check emulator is available
          command: |
            while ! adb shell getprop ro.build.version.sdk; do
              sleep 1
            done

jobs:
  package:
    docker:
      - image: cimg/android:2022.06
    steps:
      - checkout
      - android/restore-gradle-cache:
          cache-prefix: package
      - run:
          name: Validate package creation
          command: ./gradlew packageRelease --console=plain -PdisablePreDex
      - run:
          name: Validate Javadoc
          command: ./gradlew Javadoc
      - store_artifacts:
          path: ./launchdarkly-android-client-sdk/build/reports/
      - android/save-gradle-cache:
          cache-prefix: package

  unit-tests:
    docker:
      - image: cimg/android:2022.06
    steps:
      - checkout
      - android/restore-gradle-cache:
          cache-prefix: unit
      - run:
          name: Build unit tests
          command: ./gradlew :launchdarkly-android-client-sdk:assembleDebugUnitTest
      - run:
          name: Run local tests
          command: ./gradlew :launchdarkly-android-client-sdk:testDebugUnitTest
      - android/save-gradle-cache:
          cache-prefix: unit
      - store_test_results:
          path: ./launchdarkly-android-client-sdk/build/test-results/testDebugUnitTest

  instrumented-tests:
    parameters:
      api-level:
        type: integer

    executor:
      name: android/android-machine
      tag: 202102-01
      resource-class: large

    steps:
      - checkout
      - android/start-emulator-and-run-tests:
          avd-name: ci-android-avd
          system-image: system-images;android-<< parameters.api-level >>;default;x86_64
          run-logcat: true
          restore-gradle-cache-prefix: instrumented-v1
          post-emulator-launch-assemble-command: ./gradlew :launchdarkly-android-client-sdk:assembleDebugAndroidTest
          pre-run-tests-steps:
            - check-emulator-available
            # Necessary for test mocking to disable network access through WiFi
            # configuration, allowing testing of behavior when device is offline
            - run:
                name: Disable mobile data for network tests
                command: adb shell svc data disable
          test-command: ./gradlew connectedDebugAndroidTest
          post-run-tests-steps:
            - store_test_results:
                path: ./launchdarkly-android-client-sdk/build/outputs/androidTest-results/
            - store_artifacts:
                path: ./launchdarkly-android-client-sdk/build/reports/

  contract-tests:
    parameters:
      api-level:
        type: integer

    executor:
      name: android/android-machine
      tag: 202102-01
      resource-class: large

    environment:
      TEST_HARNESS_PARAMS: -junit /home/circleci/junit/contract-tests-junit.xml

    steps:
      - checkout
      - android/start-emulator-and-run-tests:
          avd-name: ci-android-avd
          system-image: system-images;android-<< parameters.api-level >>;default;x86_64
          run-logcat: true
          restore-gradle-cache-prefix: contract-v1
          post-emulator-launch-assemble-command: make build-contract-tests
          pre-run-tests-steps:
            - check-emulator-available
            - run: mkdir -p ~/junit
            - run: make start-contract-test-service
          test-command: make run-contract-tests
          post-run-tests-steps:
            - store_test_results:
                path: ~/junit
            - store_artifacts:
                path: ./launchdarkly-android-client-sdk/build/reports/
